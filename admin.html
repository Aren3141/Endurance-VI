<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Endurance VI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a1a; color: #e5e5e5; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #ef4444; color: white; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .chat-message-container:hover .delete-chat-btn { opacity: 1; }
    </style>
</head>
<body class="antialiased">

    <!-- Welcome Message -->
    <div id="welcome-message" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-green-700 text-white py-2 px-6 rounded-lg shadow-lg z-50 transition-opacity duration-500 opacity-0"></div>

    <div class="flex h-screen bg-gray-900">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-gray-800 p-4">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold tracking-wider">ENDURANCE <span class="text-red-500">VI</span></h1>
                <p class="text-gray-400 text-sm">Admin Panel</p>
            </div>
            <nav class="space-y-2">
                <a href="#" id="nav-messages" class="sidebar-link active flex items-center p-3 rounded-lg">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    Inbox
                </a>
                <a href="#" id="nav-files" class="sidebar-link flex items-center p-3 rounded-lg">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    File Uploads
                </a>
                <a href="#" id="nav-chat" class="sidebar-link flex items-center p-3 rounded-lg">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    Admin Chat
                </a>
            </nav>
            <div class="absolute bottom-4 left-4 w-56">
                <a href="index.html" class="sidebar-link block w-full text-center p-3 rounded-lg text-gray-300 bg-gray-700 hover:bg-gray-600">View Main Site</a>
                <button id="logout-button" class="mt-2 sidebar-link block w-full text-center p-3 rounded-lg text-gray-300 bg-red-800 hover:bg-red-700">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <!-- Inbox View -->
            <div id="view-messages">
                <h2 class="text-3xl font-bold mb-6">Contact Inbox</h2>
                <div id="messages-list" class="space-y-4">
                    <p>Loading messages...</p>
                </div>
            </div>

            <!-- File Uploads View -->
            <div id="view-files" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Upload & Manage Files</h2>
                <div class="bg-gray-800 p-6 rounded-lg mb-8">
                    <h3 class="font-bold mb-4">Upload New File</h3>
                    <input type="file" id="file-input" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700"/>
                    <button id="upload-button" class="mt-4 bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold">Upload</button>
                    <div id="upload-progress" class="mt-4 w-full bg-gray-700 rounded-full h-2.5 hidden"><div id="progress-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
                <div>
                    <h3 class="font-bold mb-4">Uploaded Files</h3>
                    <div id="files-list" class="space-y-3">
                        <p>Loading files...</p>
                    </div>
                </div>
            </div>

            <!-- Admin Chat View -->
            <div id="view-chat" class="hidden h-full flex flex-col">
                <h2 class="text-3xl font-bold mb-6">Admin Group Chat</h2>
                <div id="chat-messages-container" class="flex-1 bg-gray-800 rounded-lg p-4 overflow-y-auto space-y-4">
                    <!-- Chat messages will be loaded here -->
                </div>
                <form id="chat-form" class="mt-4 flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-gray-700 border-gray-600 text-white rounded-md p-3 focus:ring-red-500 focus:border-red-500" required>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50">
                        Send
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Message Detail Modal -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg max-w-2xl w-full">
            <h3 id="modal-name" class="text-2xl font-bold"></h3>
            <p id="modal-email" class="text-sm text-red-400 mb-4"></p>
            <p id="modal-message" class="text-gray-300 whitespace-pre-wrap mb-6"></p>
            <div id="modal-footer" class="flex justify-end space-x-4">
                <a id="modal-reply-btn" href="#" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">Reply</a>
                <button id="modal-delete-btn" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold hidden">Delete</button>
                <button id="modal-close-btn" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold">Close</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { firebaseConfig } from './firebase-config.js';
        
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            const errorHTML = ⁠ <div style="color: white; background-color: #ef4444; padding: 20px; font-size: 1.2em; text-align: center; height: 100vh; display: flex; align-items: center; justify-content: center;"> <div style="max-width: 600px;"> <h1 style="font-size: 2em; margin-bottom: 1em;">Firebase Configuration Error</h1> <p>Your app is not connected to Firebase. You must replace the placeholder 'firebaseConfig' object in your <strong>admin.html, login.html, and index.html</strong> files with the actual configuration keys from your Firebase project console.</p> <p style="margin-top: 1em; font-size: 0.8em; color: #fecaca;">The Firestore connection will fail until this is corrected.</p></div></div> ⁠;
            document.body.innerHTML = errorHTML;
            throw new Error("Firebase configuration is missing. Please add your project keys.");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, orderBy, query, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentUserData = {};
        const SUPER_ADMIN_EMAIL = 'arenkoprulu@gmail.com';

        const showWelcomeMessage = (userName) => {
            if (sessionStorage.getItem('welcomeShown')) return;
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.textContent = ⁠ Welcome, ${userName} ⁠;
            welcomeMessage.classList.remove('hidden');
            setTimeout(() => { welcomeMessage.classList.remove('opacity-0'); }, 10);
            setTimeout(() => { welcomeMessage.classList.add('opacity-0'); }, 2000);
            setTimeout(() => { welcomeMessage.classList.add('hidden'); }, 2500);
            sessionStorage.setItem('welcomeShown', 'true');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                currentUserData = userDocSnap.exists() ? userDocSnap.data() : { displayName: user.email, email: user.email };
                
                showWelcomeMessage(currentUserData.displayName);
                // Load user-dependent content now that we have the user object
                loadFiles(); 
            } else {
                currentUser = null;
                currentUserData = {};
                window.location.href = './login.html';
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth).then(() => {
                sessionStorage.removeItem('welcomeShown');
            }).catch(error => console.error("Logout error", error));
        });

        const navLinks = { 
            messages: document.getElementById('nav-messages'), 
            files: document.getElementById('nav-files'),
            chat: document.getElementById('nav-chat')
        };
        const views = { 
            messages: document.getElementById('view-messages'), 
            files: document.getElementById('view-files'),
            chat: document.getElementById('view-chat')
        };
        
        const switchView = (viewName) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            views[viewName].classList.remove('hidden');
            navLinks[viewName].classList.add('active');
        };

        navLinks.messages.addEventListener('click', (e) => { e.preventDefault(); switchView('messages'); });
        navLinks.files.addEventListener('click', (e) => { e.preventDefault(); switchView('files'); });
        navLinks.chat.addEventListener('click', (e) => { e.preventDefault(); switchView('chat'); });

        const messagesList = document.getElementById('messages-list');
        const modal = document.getElementById('message-modal');
        const messagesQuery = query(collection(db, "contactMessages"), orderBy("timestamp", "desc"));

        onSnapshot(messagesQuery, (snapshot) => {
            if (snapshot.empty) {
                messagesList.innerHTML = '<p>No messages yet.</p>'; return;
            }
            messagesList.innerHTML = '';
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold">${data.name}</p>
                        <p class="text-sm text-gray-400">${new Date(data.timestamp?.toDate()).toLocaleString()}</p>
                    </div>
                    <p class="text-gray-300 truncate">${data.message}</p>`;
                div.addEventListener('click', () => showMessageModal(docSnap.id, data));
                messagesList.appendChild(div);
            });
        });

        const showMessageModal = (id, data) => {
            document.getElementById('modal-name').textContent = data.name;
            document.getElementById('modal-email').textContent = data.email;
            document.getElementById('modal-message').textContent = data.message;
            document.getElementById('modal-reply-btn').href = ⁠ mailto:${data.email} ⁠;
            
            const deleteBtn = document.getElementById('modal-delete-btn');
            if(currentUser && currentUser.email === SUPER_ADMIN_EMAIL) {
                deleteBtn.classList.remove('hidden');
                deleteBtn.onclick = () => deleteMessage(id);
            } else {
                 deleteBtn.classList.add('hidden');
            }
            modal.classList.add('flex');
        };

        const deleteMessage = async (id) => {
            if (prompt("Type 'DELETE' to confirm.") === 'DELETE') {
                await deleteDoc(doc(db, "contactMessages", id));
                modal.classList.remove('flex');
            }
        };

        modal.querySelector('#modal-close-btn').addEventListener('click', () => modal.classList.remove('flex'));
        
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const filesList = document.getElementById('files-list');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        
        uploadButton.addEventListener('click', () => {
            const file = fileInput.files[0]; if (!file) return;
            const storageRef = ref(storage, ⁠ uploads/${file.name} ⁠);
            const uploadTask = uploadBytesResumable(storageRef, file);
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgress.classList.remove('hidden');
                    progressBar.style.width = progress + '%';
                }, 
                (error) => { console.error("Upload error", error); }, 
                () => { getDownloadURL(uploadTask.snapshot.ref).then(() => { fileInput.value = ''; uploadProgress.classList.add('hidden'); loadFiles(); }); }
            );
        });

        const loadFiles = async () => {
            const listRef = ref(storage, 'uploads');
            filesList.innerHTML = '';
            try {
                const res = await listAll(listRef);
                if (res.items.length === 0) { filesList.innerHTML = '<p>No files uploaded yet.</p>'; return; }
                const isSuperAdmin = currentUser && currentUser.email === SUPER_ADMIN_EMAIL;

                res.items.forEach(async (itemRef) => {
                    const url = await getDownloadURL(itemRef);
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-3 rounded-lg flex justify-between items-center';
                    const deleteBtnHTML = isSuperAdmin ? ⁠ <button data-ref-path="${itemRef.fullPath}" class="delete-file-btn text-sm bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md">Delete</button> ⁠ : '';
                    div.innerHTML = `
                        <span class="truncate">${itemRef.name}</span>
                        <div>
                            <a href="${url}" target="_blank" class="text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md mr-2">Download</a>
                            ${deleteBtnHTML}
                        </div>`;
                    filesList.appendChild(div);
                });
            } catch (error) { console.error("Error loading files:", error); filesList.innerHTML = '<p>Could not load files.</p>'; }
        };
        
        filesList.addEventListener('click', async (e) => {
            if(e.target.classList.contains('delete-file-btn') && e.target.dataset.refPath) {
                if(prompt("Type 'DELETE' to confirm.") === 'DELETE') {
                    const fileRef = ref(storage, e.target.dataset.refPath);
                    await deleteObject(fileRef);
                    loadFiles();
                }
            }
        });
        
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatQuery = query(collection(db, "adminChat"), orderBy("timestamp"));

        onSnapshot(chatQuery, (snapshot) => {
            chatMessagesContainer.innerHTML = '';
            const isSuperAdmin = currentUser && currentUser.email === SUPER_ADMIN_EMAIL;
            snapshot.forEach(docSnap => {
                const msg = docSnap.data();
                const msgId = docSnap.id;
                const isCurrentUser = currentUser && msg.userId === currentUser.uid;

                const messageWrapper = document.createElement('div');
                messageWrapper.className = ⁠ chat-message-container flex items-end gap-2 ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'} ⁠;
                
                const deleteBtnHTML = isSuperAdmin ? `<button data-msg-id="${msgId}" class="delete-chat-btn opacity-0 transition-opacity text-gray-500 hover:text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                </button>` : '';

                messageWrapper.innerHTML = `
                     <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                        <p class="text-xs text-gray-400 mb-1 px-1">${msg.userName || msg.userEmail}</p>
                        <div class="p-3 rounded-lg max-w-md ${isCurrentUser ? 'bg-red-700 text-white' : 'bg-gray-700'}">
                            ${msg.text}
                        </div>
                    </div>
                `;
                 if (!isCurrentUser) {
                    messageWrapper.insertAdjacentHTML('beforeend', deleteBtnHTML);
                 } else {
                    messageWrapper.insertAdjacentHTML('afterbegin', deleteBtnHTML);
                 }

                chatMessagesContainer.appendChild(messageWrapper);
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        });

        chatMessagesContainer.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-chat-btn');
            if (deleteBtn && deleteBtn.dataset.msgId) {
                const msgId = deleteBtn.dataset.msgId;
                 if (prompt("Type 'DELETE' to confirm deleting this chat message.") === 'DELETE') {
                    await deleteDoc(doc(db, "adminChat", msgId));
                }
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            const sendButton = chatForm.querySelector('button[type="submit"]');

            if (!messageText || !currentUser) return;

            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';

            try {
                await addDoc(collection(db, "adminChat"), {
                    text: messageText,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUserData.displayName
                });
                chatInput.value = '';
            } catch (error) {
                console.error("Error sending chat message:", error);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        });
    </script>
</body>
</html>